# 工作流的名称
name: Update AdGuard Home Rules

# 触发工作流的条件
on:
  workflow_dispatch:
  schedule:
    - cron: '15 3 * * *'

# 定义一个名为 'build' 的任务
jobs:
  build:
    # 任务运行的虚拟环境
    runs-on: ubuntu-latest

    # ===============================================================
    # ↓↓↓ 新增这部分来授予写权限 ↓↓↓
    permissions:
      contents: write
    # ↑↑↑ 新增这部分来授予写权限 ↑↑↑
    # ===============================================================

    # 任务包含的步骤
    steps:
      # 第一步：检出你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：下载、合并和去重规则
      - name: Fetch, merge and deduplicate rules
        run: |
          TEMP_FILE="temp_rules.txt"
          OUTPUT_FILE="adguard-rules.txt"
          URLS=(
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_53.txt"
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_50.txt"
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_8.txt"
            "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.mini.txt"
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_45.txt"
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_48.txt"
          )
          
          > $TEMP_FILE

          echo "Downloading rules..."
          for url in "${URLS[@]}"; do
            curl -sL "$url" >> $TEMP_FILE || echo "Failed to download $url"
          done

          echo "Processing rules..."
          grep -vE "^#|^!|^\s*$" $TEMP_FILE | sed 's/\r$//' | sort -u > $OUTPUT_FILE

          rm $TEMP_FILE
          
          echo "Done. Final list saved to $OUTPUT_FILE"

      # 第三步：提交并推送更改到仓库
      - name: Commit and push if changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add adguard-rules.txt
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: Auto update adguard rules on $(date)"
            git push
          fi
