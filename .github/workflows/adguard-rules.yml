# 工作流的名称
name: Update AdGuard Home Rules

# 触发工作流的条件
on:
  # 允许手动触发
  workflow_dispatch:

  # 定时触发
  schedule:
    # 将 cron 表达式修改为每6小时运行一次
    # 这会在 UTC 时间的 0点, 6点, 12点, 18点 触发
    - cron: '0 */6 * * *'

# 定义一个名为 'build' 的任务
jobs:
  build:
    # 任务运行的虚拟环境
    runs-on: ubuntu-latest

    # 授予工作流写入仓库内容的权限
    permissions:
      contents: write

    # 任务包含的步骤
    steps:
      # 第一步：检出你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：下载、合并、去重并添加头部信息
      - name: Fetch, merge, deduplicate, and add header
        run: |
          TEMP_FILE="temp_rules.txt"
          OUTPUT_FILE="adguard-rules.txt"
          URLS=(
            # AWAvenue Ads Rule
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_53.txt"
            # uBlock₀ filters – Badware risks
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_50.txt"
            # HaGeZi's Threat Intelligence Feeds DNS Blocklist - mini version
            "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.mini.txt"
            # HaGeZi's Allowlist Referral
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_45.txt"
            # HaGeZi's Pro Blocklist
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_48.txt"
          )
          
          echo "Downloading rules..."
          > $TEMP_FILE
          for url in "${URLS[@]}"; do
            curl -sL "$url" >> $TEMP_FILE || echo "Failed to download $url"
          done

          echo "Processing rules and adding header..."
          (
            echo "! Title: H-AD-DNS"
            echo "! Last modified: $(TZ='Asia/Shanghai' date +'%Y-%m-%d-%I:%M%p')(UTC+8)"
            # --- 修正点 1 ---
            echo "! Total rules: $(grep -vE '^#|^!|^\s*$' $TEMP_FILE | sed 's/\r$//' | sort -u | wc -l)"
            echo ""
            # --- 修正点 2 ---
            grep -vE '^#|^!|^\s*$' $TEMP_FILE | sed 's/\r$//' | sort -u
          ) > $OUTPUT_FILE

          rm $TEMP_FILE
          echo "Done. Final list with header saved to $OUTPUT_FILE"

      # 第三步：提交并推送更改到仓库
      - name: Commit and push if changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add adguard-rules.txt
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat: Update rules and metadata on $(TZ='Asia/Shanghai' date)"
            git push
          fi
