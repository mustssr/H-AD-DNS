# 工作流的名称
name: Update AdGuard Home Rules

# 触发工作流的条件
on:
  # 允许手动触发
  workflow_dispatch:

  # 定时触发
  schedule:
    # 将 cron 表达式修改为每8小时运行一次
    - cron: '0 */8 * * *'

# 定义一个名为 'build' 的任务
jobs:
  build:
    # 任务运行的虚拟环境
    runs-on: ubuntu-latest

    # 任务包含的步骤
    steps:
      # 第一步：检出你的仓库代码
      # 关键改动(1): 使用你的个人访问令牌 (PAT) 来检出代码。
      # 这样后续的 git 操作将以你的身份（管理员）进行，从而绕过分支保护规则。
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTION_PAT }}

      # 第二步：下载、合并、去重并添加头部信息
      - name: Fetch, merge, deduplicate, and add header
        run: |
          TEMP_FILE="temp_rules.txt"
          OUTPUT_FILE="adguard-rules.txt"
          URLS=(
              # AWAvenue Ads Rule
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_53.txt"
              # uBlock₀ filters – Badware risks
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_50.txt"
              # HaGeZi's Threat Intelligence Feeds DNS Blocklist - mini version
            "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.mini.txt"
              # HaGeZi's Allowlist Referral
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_45.txt"
              # HaGeZi's Pro Blocklist
            "https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/refs/heads/main/assets/filter_48.txt"
          )
          
          echo "Downloading rules..."
          > $TEMP_FILE
          for url in "${URLS[@]}"; do
            curl -sL "$url" >> $TEMP_FILE || echo "Failed to download $url"
          done

          echo "Processing rules and adding header..."
          (
            echo "! Title: H-AD-DNS"
            echo "! Last modified: $(TZ='Asia/Shanghai' date +'%Y-%m-%d-%I:%M%p')(UTC+8)"
            echo "! Total rules: $(grep -vE '^#|^!|^\s*$' $TEMP_FILE | sed 's/\r$//' | sort -u | wc -l)"
            echo ""
            grep -vE '^#|^!|^\s*$' $TEMP_FILE | sed 's/\r$//' | sort -u
          ) > $OUTPUT_FILE

          rm $TEMP_FILE
          echo "Done. Final list with header saved to $OUTPUT_FILE"

      # 第三步：提交并推送更改到仓库
      # 关键改动(2): 使用一个专门的 Action 来自动提交和推送。
      # 它会自动检测文件变化，并使用 checkout 步骤中设置好的 PAT 进行推送。
      # 这样更简洁、更稳定。
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat: Auto-update AdGuard rules"
          # 确保指定正确的文件名，如果只修改这一个文件
          file_pattern: adguard-rules.txt
          # 推送到主分支
          branch: main
